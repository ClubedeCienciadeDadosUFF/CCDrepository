<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
  	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/map.css">
  	<script type="text/javascript" src="js/leafletembed.js"></script>
  	<script src="js/data.js"></script>
  	<link href="css/simple-sidebar.css" rel="stylesheet">
  	<link href="css/button.css" rel="stylesheet">
  	<link rel="stylesheet" href="css/leaflet.awesome-markers.css">
  	<script src="js/leaflet.awesome-markers.js"></script>
  	<link rel="stylesheet" href="font-awesome/css/font-awesome.min.css">
  	<link rel="stylesheet" href="http://code.ionicframework.com/ionicons/1.5.2/css/ionicons.min.css">
  	<link rel="stylesheet" href="css/build.css"> <!-- This is the checkbox and RadioButton -->
  	<link rel="stylesheet" href="css/info.css">
  	<link rel="stylesheet" href="css/legend.css">
    <title> SIAC </title>
  </head>
  <body>
  	
  	<div id="wrapper">      

  		<!-- /#sidebar-wrapper -->
  		<div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="#">
                        SIAC
                    </a>
                </li>
                <li>
				    <a href="#" id="show-occurrences" onclick="onClickOccurrences()">
				    	Marcar Ocorrências
				    </a>
                    <!--<a id="importData" href="#">Importar dados</a> -->
                </li>
                <li>
                	<a href="#" id="show-inductions" onclick="onClickInductions()">
                		Marcar Induções
                	</a>
                </li>
            </ul>
        </div>
        <!-- /#sidebar-wrapper -->

        <!-- map-wrapper -->
	    <div id="map-wrapper">
	      <div id="map" class="leaf-container"> </div>
	    </div>
	    <!-- /#map-wrapper -->

	</div>

    <script>

    /*Markers type */
    var rouboMarker = L.AwesomeMarkers.icon({
    icon: 'user',
    prefix: 'fa',
    markerColor: 'red'
  	});
  	var furtoMarker = L.AwesomeMarkers.icon({
    icon: 'user',
    prefix: 'fa',
    markerColor: 'blue'
  	});
  	var rouboDeVeiculoMarker = L.AwesomeMarkers.icon({
    icon: 'user',
    prefix: 'fa',
    markerColor: 'green'
  	});
  	var assaltoAGrupoMarker = L.AwesomeMarkers.icon({
    icon: 'user',
    prefix: 'fa',
    markerColor: 'black'
  	});
  	var tentativaDeAssaltoMarker = L.AwesomeMarkers.icon({
    icon: 'user',
    prefix: 'fa',
    markerColor: 'orange'
  	});
  	var sequestroRelampagoMarker = L.AwesomeMarkers.icon({
    icon: 'user',
    prefix: 'fa',
    markerColor: 'purple'
  	});
  	var arrombamentoVeicularMarker = L.AwesomeMarkers.icon({
    icon: 'user',
    prefix: 'fa',
    markerColor: 'cadetblue'
  	});
  	var arrombamentoDomiciliarMarker = L.AwesomeMarkers.icon({
    icon: 'user',
    prefix: 'fa',
    markerColor: 'darkred'
  	});
  	var arrastaoMarker = L.AwesomeMarkers.icon({
    icon: 'user',
    prefix: 'fa',
    markerColor: 'darkgreen'
  	});

  	var legend = L.control({position: 'bottomright'});

	legend.onAdd = function (map) 
	{
	    var div = L.DomUtil.create('div', 'info legend'),
	        grades = [0, 20, 30, 40, 80, 110, 140],
	        labels = [];

	    // loop through our density intervals and generate a label with a colored square for each interval
	    for (var i = 0; i < grades.length; i++) {
	        div.innerHTML +=
	            '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
	            grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
	    }

	    return div;
	};

  	/* variables */
  	var occurrencesGroupLayer = null;

  	var neighbourhoodsGroupLayer = null;

  	var timeMap = {"dawn":"Madrugada", "night":"Noite", "morning":"Manhã", "evening":"Tarde"}
  	var dateMap = {"business_day":"Dia de semana", "weekend":"Fim de semana"}

  	var info = L.control({position:'topright'});
  	info.onAdd = function (map) 
  	{
	    this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
	    this.update();
	    return this._div;
	};
	info.update = function (props) 
	{
		var inductionsString = "";
		if(props)
		{
			if(props.inductions.length >= 1)
				inductionsString = props.inductions[0] + "<br/>";
			for(var i = 1; i < props.inductions.length; i++)
			{
				inductionsString += props.inductions[i] + "<br/>";
			}
		}
	    this._div.innerHTML = '<h4>Regras geradas</h4>' +  (props ?
	        '<b>' + firstToUpperCase(props.name.split('_').join(' ')) + '</b><br />' + props.density + ' ocorrências <br/>' + inductionsString
	        : 'Passe o mouse em cima de um bairro');

	};

	$(document).ready(function()
	{
		initmap();

		info.addTo(map);
		/* Occurrences data */
		var occurrencesData = JSON.parse(rawOccurrencesData);
		prepareOccurrencesData(occurrencesData);

		/* Inductions data */
		var inductionsData = JSON.parse(rawInductionsData)

		/* Neighbourhoods data from data.js */
		var neighbourhoodsData = JSON.parse(neighbourhoodsGeoJson);
		prepareNeighbourhoodsData(neighbourhoodsData, inductionsData);
	});

	function prepareOccurrencesData(occurrencesData)
	{
		occurrencesGroupLayer = L.layerGroup();
		for (var i = 0; i < occurrencesData.length; i++) 
		{
			var marker = insertMarker(occurrencesData[i]);
			insertPopUp(marker, occurrencesData[i]);
		};
	}
	function insertMarker(rowData)
	{
		var marker = null;
		if(rowData.occurrence_type.toLowerCase().localeCompare("roubo") == 0)
				marker = L.marker([rowData.latitude, rowData.longitude], {icon: rouboMarker});
		else if(rowData.occurrence_type.toLowerCase().localeCompare("furto") == 0)
			marker = L.marker([rowData.latitude, rowData.longitude], {icon: furtoMarker});
		else if(rowData.occurrence_type.toLowerCase().localeCompare("roubo_de_veiculo") == 0)
			marker = L.marker([rowData.latitude, rowData.longitude], {icon: rouboDeVeiculoMarker});
		else if(rowData.occurrence_type.toLowerCase().localeCompare("assalto_a_grupo") == 0) 
			marker = L.marker([rowData.latitude, rowData.longitude], {icon: assaltoAGrupoMarker});
		else if(rowData.occurrence_type.toLowerCase().localeCompare("arrastao") == 0)
			marker = L.marker([rowData.latitude, rowData.longitude], {icon: arrastaoMarker});
		else if(rowData.occurrence_type.toLowerCase().localeCompare("arrombamento_domiciliar") == 0)
			marker = L.marker([rowData.latitude, rowData.longitude], {icon: arrombamentoDomiciliarMarker});
		else if(rowData.occurrence_type.toLowerCase().localeCompare("arrombamento_veicular") == 0)
			marker = L.marker([rowData.latitude, rowData.longitude], {icon: arrombamentoVeicularMarker});
		else if(rowData.occurrence_type.toLowerCase().localeCompare("tentativa_de_assalto") == 0)
			marker = L.marker([rowData.latitude, rowData.longitude], {icon: tentativaDeAssaltoMarker});
		else if(rowData.occurrence_type.toLowerCase().localeCompare("sequestro_relampago") == 0)
			marker = L.marker([rowData.latitude, rowData.longitude], {icon: sequestroRelampagoMarker});
		return marker;
	}
	function insertPopUp(marker, rowData)
	{
		if(marker != null)
		{
			var occurrence_type = rowData.occurrence_type.toLowerCase();
			var normalizedString = occurrence_type.split('_').join(' ');
			normalizedString = firstToUpperCase(normalizedString);
			var objects = "";
			$.each(rowData, function(k, v) 
			{
				value = v.toString();
				value = value.toLowerCase();
			    if(value.localeCompare("true") == 0)
			    	objects +=  firstToUpperCase(k.split('_').join(' ')) + ", ";
			});
			objects = objects.replace(/,\s*$/, "");
			marker.bindPopup("<b>" + normalizedString + "</b>" + "<br><b>" + "Objetos roubados : " + "</b>" + objects + "." + "<br><b>" + "Hora : " + "</b>" + rowData.time);
			occurrencesGroupLayer.addLayer(marker);
		}
	}
	function firstToUpperCase( str ) 
	{
    	return str.substr(0, 1).toUpperCase() + str.substr(1);
	}
	function prepareNeighbourhoodsData(neighbourhoodsData, inductionsData)
	{
		var features = [];
		for(k in neighbourhoodsData.features)
		{
			neighbourhoodsData.features[k].properties.inductions = [];
		}
		for(var i = 0; i < inductionsData.rules.length; i++)
		{
			var neighbourhood = inductionsData.rules[i].geo_position;
			if(neighbourhood.localeCompare("") != 0)
			{
				for (j in neighbourhoodsData.features)
				{
					//console.log("Feature name : ", neighbourhoodsData.features[j].properties.name);
					//console.log("Neighbourhood : ", neighbourhood);
					if(neighbourhood.localeCompare(neighbourhoodsData.features[j].properties.name) == 0)
					{
						insertInduction(neighbourhoodsData.features[j], inductionsData.rules[i]);
						features.push(neighbourhoodsData.features[j]);
						break;
					}
				}
			}
		}
		neighbourhoodsGroupLayer = L.geoJson(features, {style : featureStyle, onEachFeature : onEachFeature});
	}
	function insertInduction(feature, induction)
	{
		var date = dateMap[induction.date];
		if(!date)
			date = "";
		var occurrenceType = induction.occurence_type;
		console.log(occurrenceType);
		if(!occurrenceType)
			occurrenceType = "";
		var time = timeMap[induction.time];
		if(!time)
			time = "";
		var nearbyLocations = induction.nearby_locations;
		var objects = induction.stolen_objects;
		var objectsString = "";
		for(var i = 0; i < objects.length; i++)
		{
			value = objects[i].toString();
			value = value.toLowerCase();
		    	objectsString +=  firstToUpperCase(value.split('_').join(' ')) + ", ";
		};
		objectsString = objectsString.replace(/,\s*$/, "");
		
		var nearbyLocationsString = "";
		for(var i = 0; i < nearbyLocations.length; i++)
		{
			value = nearbyLocations[i].toString();
			value = value.toLowerCase();
		    	nearbyLocationsString +=  firstToUpperCase(value.split('_').join(' ')) + ", ";
		};
		nearbyLocationsString = nearbyLocationsString.replace(/,\s*$/, "");
		
		var inductionString = (date.localeCompare("") != 0 ? firstToUpperCase(date) + " e " : "") + (time.localeCompare("") != 0 ? firstToUpperCase(time) + " e " : "") +
		(nearbyLocationsString.localeCompare("") != 0 ? nearbyLocationsString + " e ": "") + (objectsString.localeCompare("") != 0 ? objectsString + " e " : "");
		inductionString = inductionString.replace(/e\s*$/, "");
		inductionString = inductionString + (occurrenceType.localeCompare("") != 0 ? " -> " + firstToUpperCase(occurrenceType) : "");
		var len = feature.properties.inductions.length;
		inductionString = (len + 1) + ". " + inductionString;
		feature.properties.inductions.push(inductionString);

		//console.log(inductionString);
	}
	function onEachFeature(feature, layer) 
	{
	    layer.on(
	    {
	        mouseover: highlightFeature,
	        mouseout: resetHighlight,
	        click: zoomToFeature
    	});
	}
	function featureStyle(feature) 
	{
	    return {
	        fillColor: getColor(feature.properties.density),
	        weight: 2,
	        opacity: 1,
	        color: 'white',
	        dashArray: '3',
	        fillOpacity: 0.7};
	}
	function getColor(d) {

    return d > 140  ? '#800026' :
           d > 110  ? '#BD0026' :
           d > 80   ? '#E31A1C' :
           d > 40   ? '#FC4E2A' :
           d > 30   ? '#FD8D3C' :
           d > 20   ? '#FEB24C' :
           d > 10   ? '#FED976' :
                      '#FFEDA0';
	}
	function zoomToFeature(e) 
	{
	    map.fitBounds(e.target.getBounds());
	}
	function highlightFeature(e) 
	{
	    var layer = e.target;

	    layer.setStyle(
	    {
	        weight: 5,
	        color: '#666',
	        dashArray: '',
	        fillOpacity: 0.7
	    });

	    if (!L.Browser.ie && !L.Browser.opera)
	    {
	        layer.bringToFront();
	    }
	    info.update(layer.feature.properties);
	}
	function resetHighlight(e) 
	{
	    neighbourhoodsGroupLayer.resetStyle(e.target);
	    info.update();
	}
	function onClickInductions()
    {
    	map.removeLayer(occurrencesGroupLayer);
    	document.getElementById("show-occurrences").textContent = "Marcar ocorrências";
    	if(!map.hasLayer(neighbourhoodsGroupLayer))
    	{
    		neighbourhoodsGroupLayer.addTo(map);
    		document.getElementById("show-inductions").textContent = "Desmarcar induções";
			legend.addTo(map);
    	}
    	else
    	{
    		document.getElementById("show-inductions").textContent = "Marcar induções";
    		map.removeLayer(neighbourhoodsGroupLayer);
    		map.removeControl(legend);
    	}
    }
	function onClickOccurrences()
    {
    	map.removeLayer(neighbourhoodsGroupLayer);
    	if(document.getElementById("show-inductions").textContent.localeCompare("Desmarcar induções") == 0)
    		map.removeControl(legend);
    	document.getElementById("show-inductions").textContent = "Marcar induções";
    	if(!map.hasLayer(occurrencesGroupLayer))
    	{
    		occurrencesGroupLayer.addTo(map);
    		document.getElementById("show-occurrences").textContent = "Desmarcar ocorrências";
    	}
    	else
    	{
    		map.removeLayer(occurrencesGroupLayer);
    		document.getElementById("show-occurrences").textContent = "Marcar ocorrências";
    	}

    }
    </script>
  </body>
<html>

